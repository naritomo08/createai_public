{% extends "base2.html" %}

{% block content %}
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <h2 class="text-center mt-5">実行結果(リロードするとトップに戻ります。)</h2>
                <h3 class="mt-4">ステータス: {{ status }}</h3>
                <h3 class="mt-4">パラメータ</h3>
                <pre class="bg-light p-3 border">{{ parameters }}</pre>
                <h3 class="mt-4">出力</h3>
                <pre class="bg-light p-3 border">{{ output }}</pre>
                <h3 class="mt-4">エラー</h3>
                <pre class="bg-light p-3 border">{{ error }}</pre>

                <!-- 生成された画像 -->
                <h3 class="mt-4">生成された画像</h3>
                <div class="mt-2">
                    {% if png_urls %}
                        <a href="#" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#pngModal">View PNG</a>
                    {% endif %}
                    {% if jpg_urls %}
                        <a href="#" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#jpgModal">View JPG</a>
                    {% endif %}
                </div>

                <div class="mt-4">
                    <button class="btn btn-secondary" onclick='reflectToTop({{ parameters|tojson|safe }})'>トップに反映(高解像度化設定は除く)</button>
                </div>
                <div class="mt-4">
                    <a href="/" class="btn btn-primary">戻る</a>
                </div>
                <div class="mt-3">
                    <form id="cancelForm" method="post" action="/cancel_task">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <input type="hidden" name="task_id" value="{{ task_id }}">
                        <button type="submit" onclick="return confirmCancel()" class="btn btn-danger">タスクを削除</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- PNGモーダルの定義 -->
    <div class="modal fade" id="pngModal" tabindex="-1" aria-labelledby="pngModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="pngModalLabel">PNG画像プレビュー</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="pngCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            {% for image_url in png_urls %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <img src="{{ image_url }}" class="d-block w-100" alt="PNG Image">
                                </div>
                            {% endfor %}
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#pngCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#pngCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="togglePngSlideBtn" class="btn btn-secondary">スライドを有効化</button>
                    {% if status == 'completed' %}
                        <a href="{{ url_for('download_png_zip', task_id=task_id) }}" class="btn btn-primary">ZIPで一括DL</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- JPGモーダルの定義 -->
    <div class="modal fade" id="jpgModal" tabindex="-1" aria-labelledby="jpgModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="jpgModalLabel">JPG画像プレビュー</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="jpgCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner">
                            {% for image_url in jpg_urls %}
                                <div class="carousel-item {% if loop.first %}active{% endif %}">
                                    <img src="{{ image_url }}" class="d-block w-100" alt="JPG Image">
                                </div>
                            {% endfor %}
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#jpgCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#jpgCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="toggleJpgSlideBtn" class="btn btn-secondary">スライドを有効化</button>
                    {% if status == 'completed' %}
                        <a href="{{ url_for('download_jpg_zip', task_id=task_id) }}" class="btn btn-primary">ZIPで一括DL</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // PNGモーダルのスライド制御
    var pngCarousel = document.getElementById('pngCarousel');
    var pngCarouselInstance = new bootstrap.Carousel(pngCarousel, {
        interval: 2000,  // 自動スライドのインターバルを2秒に設定
    });
    var togglePngSlideBtn = document.getElementById('togglePngSlideBtn');
    var isPngSliding = true;  // 自動スライドを最初から有効にする

    // 初期テキストを設定
    togglePngSlideBtn.textContent = 'スライドを無効化';

    togglePngSlideBtn.addEventListener('click', function () {
        if (isPngSliding) {
            pngCarouselInstance.pause();
            togglePngSlideBtn.textContent = 'スライドを有効化';
        } else {
            pngCarouselInstance.cycle();
            togglePngSlideBtn.textContent = 'スライドを無効化';
        }
        isPngSliding = !isPngSliding;
    });

    // JPGモーダルのスライド制御
    var jpgCarousel = document.getElementById('jpgCarousel');
    var jpgCarouselInstance = new bootstrap.Carousel(jpgCarousel, {
        interval: 2000,  // 自動スライドのインターバルを2秒に設定
    });
    var toggleJpgSlideBtn = document.getElementById('toggleJpgSlideBtn');
    var isJpgSliding = true;  // 自動スライドを最初から有効にする

    // 初期テキストを設定
    toggleJpgSlideBtn.textContent = 'スライドを無効化';

    toggleJpgSlideBtn.addEventListener('click', function () {
        if (isJpgSliding) {
            jpgCarouselInstance.pause();
            toggleJpgSlideBtn.textContent = 'スライドを有効化';
        } else {
            jpgCarouselInstance.cycle();
            toggleJpgSlideBtn.textContent = 'スライドを無効化';
        }
        isJpgSliding = !isJpgSliding;
    });
</script>
{% endblock %}
